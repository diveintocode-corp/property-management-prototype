<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.app.mapper.LeaseMapper">
    
    <resultMap id="leaseWithDetails" type="Lease">
        <id property="id" column="lease_id"/>
        <result property="propertyId" column="property_id"/>
        <result property="tenantId" column="tenant_id"/>
        <result property="rent" column="rent"/>
        <result property="startDate" column="start_date"/>
        <result property="endDate" column="end_date"/>
        <result property="status" column="status"/>
        <result property="deposit" column="deposit"/>
        <result property="keymoney" column="keymoney"/>
        <result property="createdAt" column="lease_created_at"/>
        <result property="updatedAt" column="lease_updated_at"/>
        <association property="property" javaType="Property">
            <id property="id" column="property_id"/>
            <result property="name" column="property_name"/>
            <result property="address" column="property_address"/>
            <result property="area" column="property_area"/>
            <result property="rooms" column="property_rooms"/>
        </association>
        <association property="tenant" javaType="Tenant">
            <id property="id" column="tenant_id"/>
            <result property="fullName" column="tenant_full_name"/>
            <result property="phone" column="tenant_phone"/>
            <result property="email" column="tenant_email"/>
        </association>
    </resultMap>
    
    <sql id="selectLeaseWithDetails">
        SELECT l.id as lease_id,
               l.property_id,
               l.tenant_id,
               l.rent,
               l.start_date,
               l.end_date,
               l.status,
               l.deposit,
               l.keymoney,
               l.created_at as lease_created_at,
               l.updated_at as lease_updated_at,
               p.name as property_name,
               p.address as property_address,
               p.area as property_area,
               p.rooms as property_rooms,
               t.full_name as tenant_full_name,
               t.phone as tenant_phone,
               t.email as tenant_email
        FROM leases l
        JOIN properties p ON l.property_id = p.id
        JOIN tenants t ON l.tenant_id = t.id
    </sql>
    
    <select id="findAll" resultMap="leaseWithDetails">
        <include refid="selectLeaseWithDetails"/>
        ORDER BY l.start_date DESC
    </select>
    
    <select id="findById" resultMap="leaseWithDetails">
        <include refid="selectLeaseWithDetails"/>
        WHERE l.id = #{id}
    </select>
    
    <select id="findByPropertyId" resultMap="leaseWithDetails">
        <include refid="selectLeaseWithDetails"/>
        WHERE l.property_id = #{propertyId}
        ORDER BY l.start_date DESC
    </select>
    
    <select id="findByTenantId" resultMap="leaseWithDetails">
        <include refid="selectLeaseWithDetails"/>
        WHERE l.tenant_id = #{tenantId}
        ORDER BY l.start_date DESC
    </select>
    
    <select id="findActiveLeasesByPropertyId" resultMap="leaseWithDetails">
        <include refid="selectLeaseWithDetails"/>
        WHERE l.property_id = #{propertyId}
        AND l.status = 'ACTIVE'
        AND (l.end_date IS NULL OR l.end_date >= CURRENT_DATE)
    </select>
    
    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO leases (property_id, tenant_id, rent, start_date, end_date, status, deposit, keymoney)
        VALUES (#{propertyId}, #{tenantId}, #{rent}, #{startDate}, #{endDate}, #{status}, #{deposit}, #{keymoney})
    </insert>
    
    <update id="update">
        UPDATE leases 
        SET property_id = #{propertyId},
            tenant_id = #{tenantId},
            rent = #{rent},
            start_date = #{startDate},
            end_date = #{endDate},
            status = #{status},
            deposit = #{deposit},
            keymoney = #{keymoney},
            updated_at = CURRENT_TIMESTAMP
        WHERE id = #{id}
    </update>
    
    <delete id="delete">
        DELETE FROM leases WHERE id = #{id}
    </delete>
</mapper>