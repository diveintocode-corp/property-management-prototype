# パート1：アーキテクチャと完全なCRUD基盤（10分）

## 導入（1分30秒）

> 「皆様、こんにちは。プロパティ管理システムのパート1へようこそ。本システムは、物件、テナント、および賃貸契約をビジネスルールに基づいて管理するSpring Bootアプリケーションでございます。
>
> 本日は、本システムを保守可能かつスケーラブルにする**アーキテクチャの基盤**についてご説明いたします。私どもは厳格な**レイヤードアーキテクチャ**に従っております：
>
> 1. **コントローラー層：** HTTPリクエストを処理し、ビューをレンダリングいたします（Web層のロジック）。
> 2. **サービス層：** ビジネスルールを強制し、操作を調整いたします（ビジネスロジック）。
> 3. **マッパー層：** MyBatisを使用してデータベースとのやり取りを管理いたします（データロジック）。
>
> 技術スタックといたしましては、フレームワークに**Spring Boot**、データベースアクセスに**MyBatis**、サーバーサイドレンダリングに**Thymeleaf**を採用しております。本セッション終了時には、3つのコアエンティティ（物件、テナント、賃貸契約）の管理方法をご理解いただけます。」

---

## ドメインモデル — 3つのエンティティすべて（3分）

> 「まず、**ドメインモデル**から始めさせていただきます。`src/main/java/com/example/app/model`にございますクラスは、実世界のビジネスオブジェクトを表現しております。
>
> ### **1. Propertyエンティティ（物件）**
> 賃貸物件（アパート、一戸建てなど）を表現いたします。
> *   **主要フィールド：** `name`、`address`、`area`、`rooms`
> *   **バリデーション：** nameとaddressに`@NotBlank`を設定し、不完全な物件データを保存しないよう保証しております。
> *   **目的：** 大家様が管理し、賃貸する対象でございます。
>
> ### **2. Tenantエンティティ（テナント）**
> 物件を賃借する方を表現いたします。
> *   **主要フィールド：** `fullName`、`phone`、`email`
> *   **バリデーション：** fullNameに`@NotBlank`を設定し、テナント様の特定を常に可能にしております。
> *   **目的：** 物件を賃借される方々の連絡先情報でございます。
>
> ### **3. Leaseエンティティ（賃貸契約）**
> 物件とテナント間の契約を表現いたします。
> *   **主要フィールド：** 
>     - `propertyId`、`tenantId`（関係を結びつける外部キー）
>     - `status`（ACTIVE、NOTICE、ENDED）
>     - `rent`、`deposit`、`keymoney`（財務条件）
>     - `startDate`、`endDate`（契約期間）
> *   **バリデーション：** すべての必須フィールドに`@NotNull`を設定しております。
> *   **目的：** すべてを結びつける法的契約でございます。
>
> **重要なポイント：** モデルに直接**Bean Validation**アノテーションを使用することで、ビジネスロジックやデータベースに到達する前の入口で無効なデータを検出いたします。」

---

## データアクセス層（2分30秒）

> 「データベース永続化には、**MyBatis**を使用しております。Hibernateのような重量級ORMとは異なり、MyBatisはクリーンなJavaインターフェースを提供しながら、SQLを完全に制御できます。
>
> `src/main/java/com/example/app/mapper`をご覧ください。3つのマッパーインターフェースがございます：
>
> ### **PropertyMapper（物件マッパー）**
> *   `List<Property> findAll()` - すべての物件を取得
> *   `Property findById(Long id)` - 1件の物件を取得
> *   `void insert(Property property)` - 新規物件を作成
> *   `void update(Property property)` - 既存物件を更新
> *   `void delete(Long id)` - 物件を削除
>
> ### **TenantMapper（テナントマッパー）**
> *   テナントに対する同様のCRUD操作
> *   `findAll()`、`findById()`、`insert()`、`update()`、`delete()`
>
> ### **LeaseMapper（賃貸契約マッパー）**
> *   標準的なCRUD操作に加えて：
> *   `List<Lease> findByPropertyId(Long propertyId)` - 物件のすべての賃貸契約を検索
> *   `List<Lease> findByTenantId(Long tenantId)` - テナントのすべての賃貸契約を検索
> *   `List<Lease> findActiveLeasesByPropertyId(Long propertyId)` - **重要なクエリ**：ビジネスルールの強制に使用
>
> **戦略：** SQLはXMLファイル（`src/main/resources/mappers`）に配置し、Javaコードをクリーンに保ち、クエリを可視化しております。サービスはこれらのマッパーを呼び出して変更を永続化いたします。」

---

## コントローラー層 — 基本的なCRUD（3分）

> 「それでは、この機能を**コントローラー**を通じてユーザーに公開する方法をご説明いたします。
>
> ### **PropertyController**（`/properties`）
> すべての物件関連のWebリクエストを処理いたします：
> *   `GET /properties` → すべての物件を一覧表示
> *   `GET /properties/{id}` → 物件詳細を表示（賃貸契約を含む）
> *   `GET /properties/new` → 作成フォームを表示
> *   `GET /properties/{id}/edit` → 編集フォームを表示
> *   `POST /properties` → 物件を保存（作成または更新）
> *   `POST /properties/{id}/delete` → 物件を削除（ガード付き）
>
> ### **TenantController**（`/tenants`）
> テナント管理を処理いたします：
> *   `GET /tenants` → すべてのテナントを一覧表示
> *   `GET /tenants/new` → 作成フォームを表示
> *   `GET /tenants/{id}/edit` → 編集フォームを表示（テナントの賃貸契約を表示）
> *   `POST /tenants` → テナントを保存
> *   `POST /tenants/{id}/delete` → テナントを削除（ガード付き）
>
> ### **フォーム処理パターン**
> すべてのコントローラーは同じパターンに従っております：
> 1.  `@Valid @ModelAttribute`でフォームデータを受信
> 2.  `BindingResult`でバリデーションエラーを確認
> 3.  エラーが存在する場合、エラーメッセージ付きでフォームを再表示
> 4.  有効な場合、サービス層を呼び出し
> 5.  成功/エラーのフラッシュメッセージと共にリダイレクト
>
> **重要な原則：** コントローラーは「薄く」保たれております。ビジネス上の決定は行いません。Web層とサービス層の間を調整し、`properties/list`や`tenants/form`などのThymeleafテンプレート名を返すのみでございます。」

---

## まとめと次のステップ

> 「これまでの内容をまとめさせていただきます：
>
> *   **3つのコアエンティティ：** Property、Tenant、Lease—それぞれにバリデーションを実装。
> *   **MyBatisマッパー：** すべてのエンティティに対するCRUD操作のクリーンなインターフェース。
> *   **コントローラー：** フォームを処理し、サービスに委譲するWebエンドポイント。
>
> これにより、基本的な操作のための堅固な基盤が構築されました。しかし、ビジネスルールについてはいかがでしょうか？同じ物件に対して2つのアクティブな賃貸契約を作成することを防ぐものは何でしょうか？あるいは、アクティブな契約を持つ物件の削除を防ぐものは？
>
> それが**サービス層**の役割でございます。パート2で詳しくご説明いたします。」

