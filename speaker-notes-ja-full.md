## 導入（30秒）

> 「こんにちは。本日は、プロパティ管理プロトタイプについてご説明いたします。本アプリケーションは、小規模ながら実用的なSpring Bootアプリケーションで、レイヤードアーキテクチャ、セキュアな認証、および物件・テナント・賃貸契約を管理するための重要なドメインルールを実装しております。UIがサービスとバリデーションにどのようにマッピングされ、データの整合性が保たれているかをご説明いたします。」

---

## プロジェクト構造（1分）

> 「`src/main/java/com/example/app`のコードをご覧ください。本プロジェクトは、一般的なパターンに従って構成されております：
>
> * **model**（ドメインクラス）
> * **controller**（Webエンドポイントとビュー）
> * **service**（ビジネスロジックとバリデーション）
> * **mapper**（データベースアクセス用のMyBatisインターフェース）
> * **security/config**（認証とセキュリティの設定）
>
> この分離により、コントローラーをシンプルに保ち、ビジネスロジックをサービス層に集約してテストを容易にし、データベースコードをマッパーに分離しております。例えば、`src/main/java/com/example/app/controller`のコントローラーと`src/main/java/com/example/app/service`のサービス（`LeaseController`、`LeaseService`など）をご参照ください。」

---

## エンティティ層 — ドメインモデル（1分）

> 「モデルクラスをご覧ください：`User`、`Tenant`、`Property`、および`Lease`です。これらはビジネスドメインに直接マッピングされております：
>
> * `User`は認証情報を保持し、バリデーションアノテーションを使用しております。
> * `Tenant`と`Property`は、それぞれ連絡先情報と住所情報を定義しております。
> * `Lease`は物件とテナント間の契約を表し、`status`、`startDate`、`rent`、およびナビゲーションプロパティを含んでおります。`ACTIVE`、`NOTICE`、`ENDED`などのドキュメント化されたドメイン値をご確認ください。
>
> これらのクラスにはバリデーションアノテーション（例：`@NotBlank`、`@NotNull`）が付与されており、無効な入力データを早期に検出できます。」

---

## データアクセス — MyBatisマッパー（45秒）

> 「本アプリケーションは、永続化のためにMyBatisマッパーを使用しております。`src/main/java/com/example/app/mapper`に`PropertyMapper`、`TenantMapper`、`LeaseMapper`、および`UserMapper`がございます。これらは`findById`、`findAll`、`insert`、`update`、`delete`などのデータベース操作を宣言しております。サービスはこれらのマッパーを呼び出して変更を永続化いたします。重要なマッパーメソッドの一つに`findActiveLeasesByPropertyId`がございます。このメソッドは、サービスが1物件あたり1つのアクティブな賃貸契約というルールを強制するために使用されます。」

---

## サービス層 — ビジネスルールの実装場所（1分15秒）

> 「コアとなるビジネスルールは、サービス層に実装されております。サービスはインターフェースベースのパターンに従っております（依存性注入とテストに最適）：`LeaseService` / `LeaseServiceImpl`、`PropertyServiceImpl`、`TenantServiceImpl`。
>
> 重要なルール：**1物件につきACTIVEな賃貸契約は1つのみ**。賃貸契約を作成または更新する前に、サービスは当該物件に既にアクティブな賃貸契約が存在するかどうかを確認いたします。存在する場合、操作は拒否されます。このロジックは`validateLease`に集約されており、`findActiveLeasesByPropertyId`を呼び出しております。ルールをここに集約することで、クライアント側での回避を防ぎ、テストを容易にしております。
>
> その他の責任：
>
> * `PropertyService`は物件の作成/更新/削除を処理いたします。コントローラーは削除を許可する前に`LeaseService.hasActiveLeases`を参照いたします。
> * `TenantService`はテナントのCRUDを処理いたします。コントローラーは、テナントに賃貸契約が存在する場合、削除をブロックいたします。」

---

## コントローラー層 — UIエンドポイントとテンプレート（1分）

> 「コントローラーはHTTPリクエストをテンプレートとサービス呼び出しにマッピングいたします。本プロジェクトはサーバーサイドレンダリングテンプレートを使用しております：コントローラーは`properties/list`、`properties/form`、`leases/form`、`tenants/form`などのテンプレート名を返します。
>
> 例：
>
> * `LeaseController.newForm`と`LeaseController.save`はモデルデータを設定し、賃貸契約フォームを返すか、成功後にリダイレクトいたします。
> * `PropertyController`は一覧/詳細/新規作成/編集/保存/削除を処理し、アクティブな賃貸契約が存在する場合に削除をブロックいたします。
> * `TenantController`はテナントの一覧を表示し、賃貸契約が存在する場合にテナントの削除をブロックいたします。
>
> コントローラーをシンプルに保ち、ロジックをサービスに委譲することで、クリーンなコードベースを維持しております。」

---

## 例外処理、DTO、バリデーション（30秒）

> 「本アプリケーションは、モデルとDTOにBean Validationを使用しております。コントローラーは`BindingResult`を確認し、バリデーションエラーが発生した場合、メッセージ付きでフォームを再表示いたします。`IllegalStateException`や`IllegalArgumentException`などのサービス層の例外は、ドメインの問題を示すために使用され、コントローラーがこれらをキャッチして、分かりやすいメッセージやフォームエラーに変換いたします。」

---

## セキュリティと設定（45秒）

> 「セキュリティはSpring Securityを使用して実装されております：
>
> * パスワードは`UserServiceImpl`で保存前にハッシュ化（BCrypt）されております。
> * `CustomUserDetailsService`は認証用のユーザーを読み込みます。
> * `SecurityConfig`は`DaoAuthenticationProvider`を設定し、`AuthenticationManager`を構成し、フォームログインとログアウトを有効化し、CSRF保護を設定しております。パブリックエンドポイントには`/login`と`/register`が含まれております。
>
> また、ユーザーが正常に登録された際、**自動ログイン**を実行し、セッション内に`SecurityContext`を作成・保存いたします。これにより、スムーズなオンボーディング体験を提供しております。」

---

## アプリケーションの実行とデモ計画（1分）

> 「アプリケーションを実行するには：`PropertyManagementApplication.java`を右クリックし、'Run As Spring Boot App'を選択してください。ルート`/`は`/properties`にリダイレクトされるため、ログインしている場合、アプリケーションは物件一覧画面で開きます。
>
> デモシーケンス（約60秒）：
>
> 1. 新しいユーザーを登録し、自動ログインによる`/properties`へのリダイレクトを表示します。
> 2. 物件を作成します。
> 3. テナントを作成します。
> 4. 当該物件の**ACTIVE**な賃貸契約を作成します。
> 5. 同じ物件に対して2つ目の**ACTIVE**な賃貸契約を作成しようとします — サービス層での拒否を実演します。
> 6. 賃貸契約が存在する状態で物件を削除しようとします — 削除がブロックされることを表示します。
>
> これらのステップにより、主要なビジネス不変条件を実演いたします：1物件あたり1つのアクティブな賃貸契約と、保護された削除処理です。」

---

## 主要機能と要点（45秒）

> 「要点をまとめますと：
>
> * **レイヤードアーキテクチャ**（controller → service → mapper）により、保守性とテスト容易性を実現しております。
> * **サービス層でのバリデーション**：1つのACTIVEな賃貸契約ルールと削除ガードは、サービス層で強制されるため、回避できません。
> * **セキュアな認証**：BCryptハッシュ化とSpring Security統合により、登録時のスムーズな自動ログインを実現しております。
> * **サーバーサイドレンダリングテンプレート**と、ロジックをサービスに委譲する簡潔なコントローラーです。」

---

## 結論と次のステップ（30秒）

> 「本プロパティ管理プロトタイプは、適切なSpring Bootの実践方法を示しております：明確な関心の分離、集約されたルール、およびセキュアな認証です。

